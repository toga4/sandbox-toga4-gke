# Proxy Only Subnet
gcloud beta compute networks subnets create proxy-only-subnet \
  --project=sandbox-toga4-gke \
  --purpose=REGIONAL_MANAGED_PROXY \
  --role=ACTIVE \
  --region=us-central1 \
  --network=default \
  --range=10.0.0.0/23

gcloud beta compute firewall-rules create fw-allow-health-check \
  --project=sandbox-toga4-gke \
  --network=default \
  --action=allow \
  --direction=ingress \
  --source-ranges=130.211.0.0/22,35.191.0.0/16 \
  --target-tags=gke-sandbox-toga4-gke-cluster01-tokyo-55b18d75-node \
  --rules=tcp

gcloud beta compute firewall-rules create fw-allow-proxies \
  --project=sandbox-toga4-gke \
  --network=default \
  --action=allow \
  --direction=ingress \
  --source-ranges=10.0.0.0/23 \
  --target-tags=gke-sandbox-toga4-gke-cluster01-tokyo-55b18d75-node \
  --rules=tcp

gcloud beta compute addresses create gke-ingress-us-central1  \
  --project=sandbox-toga4-gke \
  --region=us-central1 \
  --network-tier=STANDARD

gcloud beta compute health-checks create http go-api-challange-hc \
  --project=sandbox-toga4-gke \
  --region=us-central1 \
  --request-path=/healthz \
  --use-serving-port

gcloud beta compute backend-services create go-api-challange-bes \
  --project=sandbox-toga4-gke \
  --load-balancing-scheme=EXTERNAL_MANAGED \
  --protocol=HTTP \
  --port-name=http \
  --health-checks=go-api-challange-hc \
  --health-checks-region=us-central1 \
  --enable-logging \
  --region=us-central1

gcloud beta compute url-maps create gke-ingress-us-central1-map \
  --project=sandbox-toga4-gke \
  --default-service=go-api-challange-bes \
  --region=us-central1

gcloud beta compute target-http-proxies create gke-ingress-us-central1-http-proxy \
  --project=sandbox-toga4-gke \
  --url-map=gke-ingress-us-central1-map \
  --url-map-region=us-central1 \
  --region=us-central1

gcloud beta compute forwarding-rules create gke-ingress-us-central1-fwd-rule \
  --project=sandbox-toga4-gke \
  --load-balancing-scheme=EXTERNAL_MANAGED \
  --network-tier=STANDARD \
  --network=default \
  --subnet=default \
  --address=gke-ingress-us-central1 \
  --ports=80 \
  --region=us-central1 \
  --target-http-proxy=gke-ingress-us-central1-http-proxy \
  --target-http-proxy-region=us-central1

gcloud beta compute backend-services add-backend go-api-challange-bes \
  --project=sandbox-toga4-gke \
  --network-endpoint-group=k8s1-5338a2d1-default-go-api-challange-80-a73f2665 \
  --network-endpoint-group-zone=us-central1-c \
  --region=us-central1 \
  --balancing-mode=RATE \
  --max-rate-per-endpoint=5
